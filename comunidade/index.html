<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Comunidade - Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    #chat { border: 1px solid #ccc; padding: 20px; height: 300px; overflow-y: scroll; }
    #mensagem { width: 80%; }
    #enviar { padding: 8px 16px; }
    .privado { color: #e67e22; }
    .publico { color: #3498db; }
  </style>
  <!-- Adicione os scripts do Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Comunidade - Chat</h1>
  <div>
    <label>Usuário: <input type="text" id="usuario" /></label>
  </div>
  <div>
    <button onclick="mudarTipo('publico')">Chat Público</button>
    <button onclick="mudarTipo('privado')">Chat Privado</button>
  </div>
  <div id="chat"></div>
  <input type="text" id="mensagem" placeholder="Digite sua mensagem..." />
  <button id="enviar">Enviar</button>

  <script>
    // Configurações do seu Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBEesXKUPQibsTXT48pQmL0yfOEHNwE85I",
      authDomain: "pixelgram-fd1bf.firebaseapp.com",
      databaseURL: "https://pixelgram-fd1bf-default-rtdb.firebaseio.com",
      projectId: "pixelgram-fd1bf",
      storageBucket: "pixelgram-fd1bf.firebasestorage.app",
      messagingSenderId: "526005169331",
      appId: "1:526005169331:web:7717c5a46a653e1ddc14c6",
      measurementId: "G-B97XPZM2FN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let tipo = 'publico';
    let codigoSalaPrivada = null;

    function mudarTipo(novoTipo) {
      tipo = novoTipo;
      if (tipo === 'privado') {
        // Pergunta se quer criar ou entrar numa sala privada
        const acao = prompt("Digite '1' para criar uma sala privada ou '2' para entrar numa sala existente:");
        if (acao === '1') {
          // Criar sala: gera código aleatório
          codigoSalaPrivada = Math.random().toString(36).substring(2, 8).toUpperCase();
          alert("Código da sua sala privada: " + codigoSalaPrivada + "\nGuarde este código para partilhar com outros.");
        } else if (acao === '2') {
          // Entrar numa sala existente
          codigoSalaPrivada = prompt("Digite o código da sala privada:");
          if (!codigoSalaPrivada) {
            tipo = 'publico';
            codigoSalaPrivada = null;
            alert("Código inválido. Voltando ao chat público.");
          }
        } else {
          tipo = 'publico';
          codigoSalaPrivada = null;
          alert("Opção inválida. Voltando ao chat público.");
        }
        document.getElementById('chat').innerHTML += `<div><em>Alterado para chat privado${codigoSalaPrivada ? " (" + codigoSalaPrivada + ")" : ""}</em></div>`;
      } else {
        codigoSalaPrivada = null;
        document.getElementById('chat').innerHTML += `<div><em>Alterado para chat público</em></div>`;
      }
      carregarMensagens();
    }

    function carregarMensagens() {
      db.ref('mensagens').off();
      db.ref('mensagens').on('value', snapshot => {
        const mensagens = snapshot.val() || [];
        document.getElementById('chat').innerHTML = '';
        Object.values(mensagens)
          .filter(m => m.tipo === tipo)
          .forEach(m => {
            document.getElementById('chat').innerHTML += `<div class="${m.tipo}"><strong>${m.usuario}:</strong> ${m.msg}</div>`;
          });
      });
    }

    document.getElementById('enviar').onclick = function() {
      const usuario = document.getElementById('usuario').value || 'Anônimo';
      const msg = document.getElementById('mensagem').value;
      // Lista simples de palavras proibidas (adicione mais se quiser)
      const proibidas = ["foda-se", "filho da puta", "merda", "caralho", "puta"];
      const msgLower = msg.toLowerCase();
      if (msg.trim() === '') return;
      if (proibidas.some(p => msgLower.includes(p))) {
        alert("Mensagem contém palavras proibidas!");
        document.getElementById('mensagem').value = '';
        return;
      }
      db.ref('mensagens').push({ usuario, msg, tipo, sala: codigoSalaPrivada });
      document.getElementById('mensagem').value = '';
    };

    carregarMensagens();
  </script>
  <script>
  // Solicita permissão para notificações ao carregar a página
  document.addEventListener('DOMContentLoaded', function() {
    if ("Notification" in window) {
      if (Notification.permission === "default") {
        Notification.requestPermission();
      }
    }
  });

  function mostrarNotificacao(titulo, corpo) {
    if (Notification.permission === "granted") {
      new Notification(titulo, { body: corpo });
    }
  }

  // Notificação ao receber nova mensagem (exceto as do próprio usuário)
  let ultimaChave = null;
  function carregarMensagens() {
    db.ref('mensagens').off();
    db.ref('mensagens').on('value', snapshot => {
      const mensagens = snapshot.val() || {};
      document.getElementById('chat').innerHTML = '';
      let chaves = Object.keys(mensagens);
      chaves.filter(k => {
        const m = mensagens[k];
        if (tipo === 'publico') return m.tipo === 'publico';
        if (tipo === 'privado') return m.tipo === 'privado' && m.sala === codigoSalaPrivada;
        return false;
      }).forEach(k => {
        const m = mensagens[k];
        document.getElementById('chat').innerHTML += `<div class="${m.tipo}"><strong>${m.usuario}:</strong> ${m.msg}</div>`;
      });

      // Notificar se chegou mensagem nova de outro usuário
      if (chaves.length > 0) {
        const ultimaMsg = mensagens[chaves[chaves.length - 1]];
        if (
          ultimaChave !== chaves[chaves.length - 1] &&
          ultimaMsg.usuario !== (document.getElementById('usuario').value || 'Anônimo')
        ) {
          mostrarNotificacao(ultimaMsg.usuario, ultimaMsg.msg);
        }
        ultimaChave = chaves[chaves.length - 1];
      }
    });
  }

  // Chame a função correta ao carregar
  carregarMensagens();
</script>
</body>
</html>